<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pemarkahan Kimia Matrikulasi</title>
    <!-- Memuatkan Tailwind CSS untuk penggayaan moden -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuatkan ikon Lucide untuk antara muka yang lebih menarik -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Memuatkan Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Pautan Ikon Google Material -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        /* Gaya tambahan untuk pengalaman pengguna yang lebih baik */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        input, select {
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input:focus, select:focus {
            box-shadow: 0 0 0 2px #3b82f6; /* focus:ring-blue-500 */
            border-color: #2563eb;
        }
        .score-input {
            background-color: #eff6ff; /* blue-50 */
        }
        .hidden {
            display: none;
        }
        /* Jadikan sel dashboard boleh diklik */
        #dashboard-table-body td {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #dashboard-table-body td:hover {
            background-color: #f0f9ff; /* sky-50 */
        }

        /* Gaya untuk cetakan laporan */
        @media print {
            body > *:not(#print-container) {
                display: none;
            }
            #print-container {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1rem;
            }
            #print-container table {
                font-size: 10px;
                width: 100%;
            }
             #print-container th, #print-container td {
                padding: 4px;
            }
        }
        
        /* Menyelaraskan ikon Google Material dengan teks */
        .material-symbols-outlined {
          font-variation-settings:
          'FILL' 0,
          'wght' 300,
          'GRAD' 0,
          'opsz' 20
        }
    </style>
</head>
<body>
    
    <!-- Bahagian Login -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h1 class="text-3xl font-bold text-center text-slate-800">Sistem Markah PB & UT Unit Kimia KMM</h1>
            <div id="login-error" class="text-red-600 text-sm text-center hidden">E-mel atau kata laluan tidak sah.</div>
            <div class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-slate-700">E-mel</label>
                    <!-- Tambah div relative untuk ikon -->
                    <div class="relative mt-1">
                        <span class="material-symbols-outlined absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">email</span>
                        <input type="email" id="email" name="email" required class="block w-full px-10 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Gunakan emel moe-dl.edu.my">
                    </div>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-slate-700">Kata Laluan </label>
                    <!-- Tambah div relative untuk ikon -->
                    <div class="relative mt-1">
                        <span class="material-symbols-outlined absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">password</span>
                        <input type="password" id="password" name="password" required class="block w-full px-10 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="********">
                    </div>
                </div>
                <button id="login-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Log Masuk
                </button>
            </div>
        </div>
    </div>

    <!-- Bahagian Aplikasi Utama (Tersembunyi pada mulanya) -->
    <div id="app-screen" class="hidden container mx-auto p-4 md:p-8">
        <!-- Tajuk Utama -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">Sistem Pemarkahan Kimia Matrikulasi</h1>
            <p class="text-slate-600 mt-2">Urus markah pelajar dengan mudah dan efisien.</p>
        </header>

        <main class="space-y-8">
            <!-- Bahagian 0: Kawalan Utama -->
            <section class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-semibold text-slate-700 mb-4 border-b pb-2 flex items-center">
                    <i data-lucide="users" class="mr-3 h-6 w-6 text-orange-600"></i>
                    Maklumat Pengguna
                </h2>
                <div class="flex justify-between items-center mb-4">
                     <div>
                        <p class="text-sm font-medium text-slate-700">Pensyarah</p>
                        <p id="lecturer-display" class="mt-1 text-lg font-semibold text-slate-800 h-10 flex items-center">-</p>
                    </div>
                     <div>
                        <p class="text-sm font-medium text-slate-700">Program</p>
                        <p id="program-display" class="mt-1 text-lg font-semibold text-slate-800 h-10 flex items-center">-</B></p>
                    </div>
                     <div>
                        <p class="text-sm font-medium text-slate-700">Peranan</p>
                        <p id="role-display" class="mt-1 text-lg font-semibold text-slate-800 h-10 flex items-center">-</B></p>
                    </div>
                     <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600 flex items-center">
                        <i data-lucide="log-out" class="mr-2 h-5 w-5"></i>
                        Log Keluar
                    </button>
                </div>
                 
                <div class="grid md:grid-cols-2 gap-4 items-end">
                    <div>
                         <label class="block text-sm font-medium text-slate-700">Kelas Aktif</label>
                         <p id="active-class-display" class="mt-1 text-lg font-semibold text-blue-600 h-10 flex items-center">-- Sila pilih dari dashboard --</p>
                    </div>
                    <div id="view-mode-wrapper" class="hidden">
                        <label for="view-mode-select" class="block text-sm font-medium text-slate-700">Tukar Paparan</label>
                        <select id="view-mode-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select>
                    </div>
                </div>
                 <p id="connection-status" class="text-sm mt-2 text-slate-500">Status: Memulakan sistem...</p>
            </section>

            <!-- Bahagian 1: Tab Utama -->
            <section id="main-content" class="bg-white p-6 rounded-lg shadow-md hidden">
                 <!-- Tab Navigation -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-dashboard" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600 flex items-center">
                             <i data-lucide="layout-dashboard" class="mr-2 h-5 w-5"></i> Dashboard
                        </button>
                        <button id="tab-entry" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent flex items-center">
                             <i data-lucide="edit" class="mr-2 h-5 w-5"></i> Kemasukan Markah
                        </button>
                        <button id="tab-report" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent flex items-center">
                           <i data-lucide="clipboard-list" class="mr-2 h-5 w-5"></i> Laporan Kelas
                        </button>
                        <!-- Tab Khas untuk Ketua Unit & Admin -->
                        <button id="tab-analysis" class="hidden whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent flex items-center">
                           <i data-lucide="bar-chart-2" class="mr-2 h-5 w-5"></i> Analisis Unit
                        </button>
                        <!-- Tab Khas untuk Admin -->
                        <button id="tab-admin" class="hidden whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent flex items-center">
                           <i data-lucide="database" class="mr-2 h-5 w-5"></i> Urus Data (Admin)
                        </button>
                    </nav>
                </div>

                <!-- Tab 1: Dashboard Pengisian Markah -->
                <div id="dashboard-content" class="mt-6">
                    <h3 class="text-lg font-semibold text-slate-800">Status Pengisian Markah</h3>
                    <p class="text-sm text-slate-500 mt-1">Jadual ini menunjukkan status pengisian markah untuk semua kelas anda. Klik pada sel (✅/❌) untuk terus mengisi markah.</p>
                    <div class="overflow-x-auto mt-4">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead id="dashboard-table-head" class="bg-slate-50">
                                <!-- Header akan dijana oleh JS -->
                            </thead>
                            <tbody id="dashboard-table-body" class="bg-white divide-y divide-slate-200">
                                <!-- Status akan dijana oleh JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 2: Kemasukan Markah -->
                <div id="entry-content" class="mt-6 hidden">
                    <div class="max-w-md">
                        <label for="assessment-select" class="block text-sm font-medium text-slate-700">2. Pilih Penilaian untuk Diisi</label>
                        <select id="assessment-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select>
                    </div>
                    <div id="mark-entry-area" class="mt-6 hidden">
                        <h3 class="text-lg font-semibold text-slate-800">Memasukkan Markah untuk: <span id="current-assessment-display" class="text-blue-600"></span></h3>
                        <p class="text-sm text-slate-500 mt-1">Anda boleh tampal (paste) senarai markah dari Excel/Sheets ke dalam ruangan markah.</p>
                        <div class="overflow-x-auto mt-4">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead id="mark-entry-head" class="bg-slate-50"></thead>
                                <tbody id="mark-entry-body" class="bg-white divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex items-center gap-4">
                            <button id="save-marks-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 flex items-center">
                                <i data-lucide="save" class="mr-2 h-5 w-5"></i>
                                Simpan Markah
                            </button>
                             <span id="save-status" class="text-green-600 font-medium hidden flex items-center gap-2">
                                <i data-lucide="check-circle-2"></i> Markah telah disimpan!
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: Laporan Kelas -->
                <div id="report-content-area" class="mt-6 hidden">
                     <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="tab-report-pb-ups" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                                Laporan PB & UPS
                            </button>
                            <button id="tab-report-topikal" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                                Laporan Ujian Topikal (ETR)
                            </button>
                        </nav>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <p class="text-slate-600">Paparan laporan untuk kelas <strong id="report-class-name" class="text-slate-800"></strong>.</p>
                        <button id="print-class-report-btn" class="bg-sky-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-sky-600 flex items-center">
                            <i data-lucide="printer" class="mr-2 h-5 w-5"></i>
                            Cetak Laporan Semasa
                        </button>
                    </div>
                    <div id="pb-ups-report-display" class="mt-4">
                        <!-- Laporan PB & UPS akan dipaparkan di sini -->
                    </div>
                    <div id="topikal-report-display" class="mt-4 hidden">
                         <!-- Laporan Ujian Topikal akan dipaparkan di sini -->
                    </div>
                </div>
                
                <!-- Tab 4: Analisis Unit (KU & Admin) -->
                <div id="analysis-content" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold text-slate-800">Analisis Prestasi Unit</h3>
                    <p class="text-sm text-slate-500 mt-1">Jadual ini menunjukkan purata markah untuk semua kelas di bawah seliaan anda.</p>
                    <div class="overflow-x-auto mt-4">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead id="analysis-table-head" class="bg-slate-50">
                                <!-- Header akan dijana oleh JS -->
                            </thead>
                            <tbody id="analysis-table-body" class="bg-white divide-y divide-slate-200">
                                <!-- Status akan dijana oleh JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 5: Urus Data (Admin) -->
                <div id="admin-content" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold text-slate-800">Mod Pentadbir: Urus Data Markah</h3>
                    <p class="text-sm text-slate-500 mt-1">Anda boleh memilih mana-mana kelas dan program untuk melihat atau mengemas kini data markah.</p>
                    
                    <div class="grid md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label for="admin-program-select" class="block text-sm font-medium text-slate-700">Pilih Program</label>
                            <select id="admin-program-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="admin-class-select" class="block text-sm font-medium text-slate-700">Pilih Kelas</label>
                            <select id="admin-class-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select>
                        </div>
                    </div>
                    
                    <div id="admin-mark-entry" class="mt-6 hidden">
                         <div class="max-w-md">
                            <label for="admin-assessment-select" class="block text-sm font-medium text-slate-700">Pilih Penilaian untuk Diisi</label>
                            <select id="admin-assessment-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select>
                        </div>
                        <div id="admin-mark-entry-area" class="mt-6 hidden">
                            <h3 class="text-lg font-semibold text-slate-800">Memasukkan Markah untuk: <span id="admin-current-assessment-display" class="text-blue-600"></span></h3>
                            <div class="overflow-x-auto mt-4">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead id="admin-mark-entry-head" class="bg-slate-50"></thead>
                                    <tbody id="admin-mark-entry-body" class="bg-white divide-y divide-slate-200"></tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex items-center gap-4">
                                <button id="admin-save-marks-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 flex items-center">
                                    <i data-lucide="save" class="mr-2 h-5 w-5"></i>
                                    Simpan Markah (Admin)
                                </button>
                                 <span id="admin-save-status" class="text-green-600 font-medium hidden flex items-center gap-2">
                                    <i data-lucide="check-circle-2"></i> Markah telah disimpan!
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Bahagian Khas untuk Cetakan -->
    <div id="print-container"></div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { createClient } = supabase;

            // =================================================================
            // BAHAGIAN KONFIGURASI PENTADBIR (ADMIN)
            // =================================================================
            const SUPABASE_URL = 'https://whgkcuudnvuuhcldqyjf.supabase.co'; // MASUKKAN URL PROJEK SUPABASE ANDA
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoZ2tjdXVkbnZ1dWhjbGRxeWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxOTMzMDEsImV4cCI6MjA3NTc2OTMwMX0.UxQZAph8XZuqX2QKflKCseTTYR2kmO0uHZvvFou5hG4'; // MASUKKAN KUNCI 'anon' 'public' SUPABASE ANDA
            const SPREADSHEET_ID = '1lKpYPqQyv1J9Lnt1kgTrnaWy3G1JsSqJpMsOgyds2qo'; // MASUKKAN ID GOOGLE SHEET ANDA
            const API_KEY = 'AIzaSyASE0C8W5yhfcU8jsK8ziijEJKr4RCFrbA'; // MASUKKAN KUNCI API GOOGLE ANDA
            // =================================================================

            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            lucide.createIcons();

            // Struktur Pemarkahan untuk kedua-dua program
            const assessmentStructures = {
                SES: {
                    topikal: [ { name: 'UT1', fullName: 'Ujian Topikal 1', fullMarks: 21 }, { name: 'UT2', fullName: 'Ujian Topikal 2', fullMarks: 10 }, { name: 'UT3', fullName: 'Ujian Topikal 3', fullMarks: 17 }, { name: 'UT4', fullName: 'Ujian Topikal 4', fullMarks: 9 }, { name: 'UT5', fullName: 'Ujian Topikal 5', fullMarks: 9 }, { name: 'UT6', fullName: 'Ujian Topikal 6', fullMarks: 30 }, ],
                    pb: [ { name: 'Tugasan', fullName: 'Tugasan Individu', fullMarks: 30, weightage: 15 }, { name: 'Amali', fullName: 'Laporan Amali', fullMarks: 30, weightage: 15 }, { name: 'Manipulatif', fullName: 'Kemahiran Manipulatif', fullMarks: 20, weightage: 10 } ],
                    ups: [ { name: 'UPS1A', fullName: 'UPS 1A', fullMarks: 13 }, { name: 'UPS1B', fullName: 'UPS 1B', fullMarks: 20 }, { name: 'UPS2', fullName: 'UPS 2', fullMarks: 10 }, { name: 'UPS3', fullName: 'UPS 3', fullMarks: 14 }, ]
                },
                SDS: { // Anda boleh ubah suai struktur SDS ini jika ia berbeza
                    topikal: [ { name: 'UT1', fullName: 'Ujian Topikal 1', fullMarks: 21 }, { name: 'UT2', fullName: 'Ujian Topikal 2', fullMarks: 10 }, { name: 'UT3', fullName: 'Ujian Topikal 3', fullMarks: 17 }, { name: 'UT4', fullName: 'Ujian Topikal 4', fullMarks: 9 }, { name: 'UT5', fullName: 'Ujian Topikal 5', fullMarks: 9 }, { name: 'UT6', fullName: 'Ujian Topikal 6', fullMarks: 30 }, ],
                    pb: [ { name: 'Tugasan', fullName: 'Tugasan Individu', fullMarks: 30, weightage: 15 }, { name: 'Amali', fullName: 'Laporan Amali', fullMarks: 30, weightage: 15 }, { name: 'Manipulatif', fullName: 'Kemahiran Manipulatif', fullMarks: 20, weightage: 10 } ],
                    ups: [ { name: 'UPS1A', fullName: 'UPS 1A', fullMarks: 13 }, { name: 'UPS1B', fullName: 'UPS 1B', fullMarks: 20 }, { name: 'UPS2', fullName: 'UPS 2', fullMarks: 10 }, { name: 'UPS3', fullName: 'UPS 3', fullMarks: 14 }, ]
                }
            };
            
            let currentAssessmentStructure = assessmentStructures.SES; // Lalai
            let allAssessments = [];
            
            const totalWeightageUPS = 20;
            const totalWeightageTopikal = 40;

            // DOM References
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const emailEl = document.getElementById('email');
            const passwordEl = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const loginErrorEl = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');

            const connectionStatusEl = document.getElementById('connection-status');
            const lecturerDisplayEl = document.getElementById('lecturer-display');
            const programDisplayEl = document.getElementById('program-display');
            const activeClassDisplayEl = document.getElementById('active-class-display');
            const roleDisplayEl = document.getElementById('role-display');
            const viewModeWrapper = document.getElementById('view-mode-wrapper');
            const viewModeSelectEl = document.getElementById('view-mode-select');
            const mainContentEl = document.getElementById('main-content');
            
            const tabDashboard = document.getElementById('tab-dashboard');
            const tabEntry = document.getElementById('tab-entry');
            const tabReport = document.getElementById('tab-report');
            const tabAnalysis = document.getElementById('tab-analysis');
            const tabAdmin = document.getElementById('tab-admin');
            
            const dashboardContent = document.getElementById('dashboard-content');
            const entryContent = document.getElementById('entry-content');
            const reportContentArea = document.getElementById('report-content-area');
            const analysisContent = document.getElementById('analysis-content');
            const adminContent = document.getElementById('admin-content');

            const dashboardTableHead = document.getElementById('dashboard-table-head');
            const dashboardTableBody = document.getElementById('dashboard-table-body');
            const analysisTableHead = document.getElementById('analysis-table-head');
            const analysisTableBody = document.getElementById('analysis-table-body');
            
            const reportClassNameEl = document.getElementById('report-class-name');
            const assessmentSelectEl = document.getElementById('assessment-select');
            const markEntryArea = document.getElementById('mark-entry-area');
            const currentAssessmentDisplay = document.getElementById('current-assessment-display');
            const markEntryHead = document.getElementById('mark-entry-head');
            const markEntryBody = document.getElementById('mark-entry-body');
            const saveMarksBtn = document.getElementById('save-marks-btn');
            const saveStatusEl = document.getElementById('save-status');
            const printClassReportBtn = document.getElementById('print-class-report-btn');
            const tabReportPbUps = document.getElementById('tab-report-pb-ups');
            const tabReportTopikal = document.getElementById('tab-report-topikal');
            const pbUpsReportDisplay = document.getElementById('pb-ups-report-display');
            const topikalReportDisplay = document.getElementById('topikal-report-display');
            const printContainer = document.getElementById('print-container');

            // DOM Admin
            const adminProgramSelect = document.getElementById('admin-program-select');
            const adminClassSelect = document.getElementById('admin-class-select');
            const adminMarkEntry = document.getElementById('admin-mark-entry');
            const adminAssessmentSelect = document.getElementById('admin-assessment-select');
            const adminMarkEntryArea = document.getElementById('admin-mark-entry-area');
            const adminCurrentAssessmentDisplay = document.getElementById('admin-current-assessment-display');
            const adminMarkEntryHead = document.getElementById('admin-mark-entry-head');
            const adminMarkEntryBody = document.getElementById('admin-mark-entry-body');
            const adminSaveMarksBtn = document.getElementById('admin-save-marks-btn');
            const adminSaveStatusEl = document.getElementById('admin-save-status');


            let state = {
                user: null, // { uid, email, role, full_name }
                allLecturers: [],
                allStudents: [], 
                visibleClasses: {}, // { "K1T1": { students: [...] }, "K2T2": ... }
                visibleLecturerClasses: [], // [ "K1T1", "K2T2" ]
                scores: {}, // { "K1T1": { "MS123": { ... } }, "K2T2": { ... } }
                currentClass: null,
                currentProgram: null,
                currentAcademicYear: "2025/2026", // Tahun akademik semasa
                viewMode: null // 'pensyarah', 'ketua_unit', 'admin'
            };
            let saveStatusTimeout;
            let adminSaveStatusTimeout;
            let channel; 

            function showSaveNotification(isAdmin = false) {
                const el = isAdmin ? adminSaveStatusEl : saveStatusEl;
                el.classList.remove('hidden');
                clearTimeout(isAdmin ? adminSaveStatusTimeout : saveStatusTimeout);
                const timeout = setTimeout(() => {
                    el.classList.add('hidden');
                }, 2000);
                if (isAdmin) {
                    adminSaveStatusTimeout = timeout;
                } else {
                    saveStatusTimeout = timeout;
                }
            }

            async function saveScoresToSupabase(isAdmin = false) {
                let classToSave = state.currentClass;
                let programToSave = state.currentProgram;
                let scoresToSave = state.scores[classToSave] || {};

                if (isAdmin) {
                    classToSave = adminClassSelect.value;
                    programToSave = adminProgramSelect.value;
                    if (!classToSave || !programToSave) {
                        alert("Sila pilih program dan kelas dahulu.");
                        return;
                    }
                    scoresToSave = state.scores[classToSave] || {};
                }

                if (!classToSave || !programToSave) return;
                 if (SUPABASE_URL === 'URL_PROJEK_SUPABASE_ANDA') {
                    alert('Sila masukkan URL dan Kunci Supabase di dalam kod sumber.');
                    return;
                }
                
                // Semak dahulu jika data wujud
                const { data, error: selectError } = await supabaseClient
                    .from('scores')
                    .select('class_name')
                    .eq('class_name', classToSave)
                    .eq('program', programToSave)
                    .eq('academic_year', state.currentAcademicYear)
                    .single();

                if (selectError && selectError.code !== 'PGRST116') { // PGRST116 = tiada baris ditemui, itu OK.
                    console.error('Error checking for existing class:', selectError);
                    alert(`Ralat semasa menyemak data: ${selectError.message}`);
                    return;
                }

                if (data) {
                    // Data wujud, jadi KEMAS KINI
                    const { error: updateError } = await supabaseClient
                        .from('scores')
                        .update({ scores_data: scoresToSave })
                        .eq('class_name', classToSave)
                        .eq('program', programToSave)
                        .eq('academic_year', state.currentAcademicYear);
                    
                    if (updateError) {
                        console.error('Error updating scores:', updateError);
                        alert(`Ralat mengemas kini data: ${updateError.message}`);
                    } else {
                        showSaveNotification(isAdmin);
                    }
                } else {
                    // Data tidak wujud, jadi MASUKKAN
                    const { error: insertError } = await supabaseClient
                        .from('scores')
                        .insert({ 
                            class_name: classToSave, 
                            program: programToSave,
                            academic_year: state.currentAcademicYear,
                            scores_data: scoresToSave 
                        });

                    if (insertError) {
                        console.error('Error inserting scores:', insertError);
                        alert(`Ralat memasukkan data: ${insertError.message}\n\nPastikan 'Row Level Security (RLS)' telah DIMATIKAN.`);
                    } else {
                        showSaveNotification(isAdmin);
                    }
                }
            }
            
            async function loadAndListenToScores() {
                if (channel) {
                    supabaseClient.removeChannel(channel);
                }
                if (!state.user || !state.visibleLecturerClasses) return;
                 if (SUPABASE_URL === 'URL_PROJEK_SUPABASE_ANDA') return;

                // 1. Fetch data untuk SEMUA kelas yang boleh dilihat
                let query = supabaseClient
                    .from('scores')
                    .select('class_name, program, scores_data')
                    .eq('academic_year', state.currentAcademicYear);
                
                if (state.user.role === 'pensyarah') {
                    query = query.in('class_name', state.visibleLecturerClasses)
                                 .eq('program', state.currentProgram);
                }
                // Jika KU atau Admin, ia akan ambil semua

                const { data, error } = await query;

                if (error) {
                    console.error("Error fetching scores:", error);
                } else {
                    state.scores = {}; // Reset
                    data.forEach(row => {
                        state.scores[row.class_name] = row.scores_data || {};
                    });
                    console.log("Markah untuk semua kelas telah dimuat turun.");
                }

                // Muat semula semua paparan
                renderDashboard();
                renderMarkEntryTable();
                if(!reportContentArea.classList.contains('hidden')) {
                    renderAllClassReports();
                }
                renderAnalysisTable();

                // 2. Dengar perubahan data
                channel = supabaseClient.channel(`scores_channel`)
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'scores',
                        filter: `academic_year=eq.${state.currentAcademicYear}`
                    }, payload => {
                        console.log('Perubahan diterima dari Supabase!', payload);
                        if (payload.new) {
                            // Hanya kemaskini jika ia relevan dengan pengguna
                            if (state.visibleLecturerClasses.includes(payload.new.class_name)) {
                                state.scores[payload.new.class_name] = payload.new.scores_data || {};
                                // Muat semula semua paparan
                                renderDashboard();
                                renderMarkEntryTable();
                                renderAnalysisTable();
                                if(!reportContentArea.classList.contains('hidden')) {
                                    renderAllClassReports();
                                }
                            }
                        }
                    })
                    .subscribe();
            }
            
            async function fetchDataFromSheet(sheetName) {
                if (SPREADSHEET_ID === 'MASUKKAN_SPREADSHEET_ID_ANDA_DI_SINI' || API_KEY === 'MASUKKAN_API_KEY_ANDA_DI_SINI') {
                    connectionStatusEl.textContent = 'Status: Ralat! Sila minta admin untuk memasukkan Spreadsheet ID dan API Key di dalam kod sumber.';
                    connectionStatusEl.className = 'text-sm mt-2 text-red-600';
                    return null;
                }
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}?key=${API_KEY}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Ralat Rangkaian: ${response.statusText}`);
                    const data = await response.json();
                    if (!data.values || data.values.length < 2) return [];
                    const headers = data.values[0];
                    const rows = data.values.slice(1);
                    return rows.map(row => {
                        let obj = {};
                        headers.forEach((header, index) => { obj[header] = row[index]; });
                        return obj;
                    });
                } catch (error) {
                    console.error(`Gagal memuat turun data dari sheet "${sheetName}":`, error);
                    connectionStatusEl.textContent = `Status: Gagal muat turun data dari Google Sheets! Periksa sambungan internet, Google API Key (pastikan tiada sekatan 'referrer'), dan Spreadsheet ID. Ralat: ${error.message}`;
                    connectionStatusEl.className = 'text-sm mt-2 text-red-600';
                    return null;
                }
            }

            async function initializeAndFetchData(user) {
                connectionStatusEl.textContent = 'Status: Sedang memuat turun data...';
                connectionStatusEl.className = 'text-sm mt-2 text-yellow-600';
                
                // 1. Dapatkan Peranan Pengguna dari Supabase
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('full_name, role')
                    .eq('id', user.id)
                    .single();

                if (profileError || !profile) {
                    connectionStatusEl.textContent = 'Status: Ralat! Profil pengguna tidak ditemui di Supabase.';
                    connectionStatusEl.className = 'text-sm mt-2 text-red-600';
                    await supabaseClient.auth.signOut();
                    return;
                }

                state.user = { uid: user.id, email: user.email, ...profile };
                state.viewMode = localStorage.getItem('viewMode_v13') || state.user.role; // Tetapkan viewMode
                
                // 2. Dapatkan data statik dari Google Sheets
                const allLecturers = await fetchDataFromSheet('SenaraiPensyarah');
                if (!allLecturers) return;
                const allStudents = await fetchDataFromSheet('SenaraiPelajar');
                if (!allStudents) return;

                state.allLecturers = allLecturers;
                state.allStudents = allStudents;
                
                // 3. Tapis data berdasarkan peranan
                
                const currentYear = state.currentAcademicYear;
                let lecturerRows = [];
                let allLecturerRowsForYear = state.allLecturers.filter(L => L.TahunAkademik === currentYear);
                
                // Dapatkan senarai kelas pensyarah ini (walaupun dia admin/ku)
                const userClasses = [...new Set(allLecturers
                    .filter(L => L.Email === user.email && L.TahunAkademik === currentYear)
                    .map(row => row.KelasDiajar.trim())
                )];

                if (state.user.role === 'pensyarah') {
                    lecturerRows = allLecturerRowsForYear.filter(L => L.Email === user.email);
                    if (lecturerRows.length === 0) {
                         connectionStatusEl.textContent = 'Status: Ralat! E-mel anda tidak ditemui dalam SenaraiPensyarah untuk tahun ini.';
                         connectionStatusEl.className = 'text-sm mt-2 text-red-600';
                         await supabaseClient.auth.signOut();
                         return;
                    }
                    state.currentProgram = lecturerRows[0].Program;
                } else {
                    // Admin & Ketua Unit melihat semua
                    lecturerRows = allLecturerRowsForYear;
                    state.currentProgram = 'Semua'; // Tetapan khas untuk paparan
                }
                
                state.visibleLecturerClasses = [...new Set(lecturerRows.map(row => row.KelasDiajar.trim()))];
                
                state.lecturerDetails = {
                    NamaPensyarah: state.user.full_name,
                    Email: state.user.email,
                    KelasDiajar: userClasses, // Hanya kelas PENSYARAH itu sendiri
                    Program: allLecturers.find(l => l.Email === user.email && l.TahunAkademik === currentYear)?.Program || 'Semua' // Program pensyarah itu
                };
                
                state.classes = {};
                const studentsForYear = state.allStudents.filter(s => s.TahunAkademik === currentYear);
                
                state.visibleLecturerClasses.forEach(className => {
                    let programForClass = state.allLecturers.find(l => l.KelasDiajar === className && l.TahunAkademik === currentYear)?.Program;

                    const studentsInClass = studentsForYear.filter(s => s.Kelas === className && s.Program === programForClass);
                    state.classes[className] = { students: studentsInClass, program: programForClass };
                });

                connectionStatusEl.textContent = 'Status: Data berjaya dimuat turun!';
                connectionStatusEl.className = 'text-sm mt-2 text-green-600';
                
                await renderApp();
            }

            async function renderApp() {
                lecturerDisplayEl.textContent = state.user.full_name;
                programDisplayEl.textContent = state.lecturerDetails.Program;
                roleDisplayEl.textContent = state.user.role.charAt(0).toUpperCase() + state.user.role.slice(1);
                
                renderViewModeSelector(); // Papar/sembunyi "Tukar Paparan"

                // Tunjukkan tab khas berdasarkan peranan
                if (state.user.role === 'admin' || state.user.role === 'ketua_unit') {
                    tabAnalysis.classList.remove('hidden');
                }
                if (state.user.role === 'admin') {
                    tabAdmin.classList.remove('hidden');
                    renderAdminTab();
                }

                const lastClass = localStorage.getItem('currentClass_supabase_v1');
                if(lastClass && state.visibleLecturerClasses.includes(lastClass)) {
                    state.currentClass = lastClass;
                }
                
                await loadAndListenToScores(); // Muat turun semua markah
                updateActiveClassDisplay(); // Kemaskini UI berdasarkan kelas yang dipilih
                renderDashboard(); // Papar dashboard
                renderAssessmentSelector(); // Sediakan dropdown
                
                mainContentEl.classList.remove('hidden'); // Tunjukkan bahagian utama
                switchTab('dashboard'); // Tetapkan dashboard sebagai tab lalai
            }
            
            function renderViewModeSelector() {
                if (state.user.role === 'pensyarah') {
                    viewModeWrapper.classList.add('hidden');
                    return;
                }
                
                viewModeWrapper.classList.remove('hidden');
                viewModeSelectEl.innerHTML = ''; // Kosongkan
                
                if (state.user.role === 'admin') {
                    viewModeSelectEl.add(new Option("Paparan Admin (Semua)", "admin"));
                }
                viewModeSelectEl.add(new Option("Paparan Ketua Unit (Semua)", "ketua_unit"));
                viewModeSelectEl.add(new Option("Paparan Pensyarah (Kelas Saya)", "pensyarah"));
                
                viewModeSelectEl.value = state.viewMode;
            }

            function updateActiveClassDisplay() {
                if (state.currentClass) {
                    activeClassDisplayEl.textContent = state.currentClass;
                } else {
                    activeClassDisplayEl.textContent = '-- Sila pilih dari dashboard --';
                }
            }

            function renderAssessmentSelector() {
                let programForStructure = state.lecturerDetails.Program;
                if (state.currentClass) {
                    programForStructure = state.classes[state.currentClass]?.program;
                } else if (state.user.role !== 'pensyarah') {
                    programForStructure = 'SES'; // Guna SES sebagai lalai jika tiada kelas aktif
                }

                currentAssessmentStructure = assessmentStructures[programForStructure] || assessmentStructures.SES;
                allAssessments = [ ...currentAssessmentStructure.topikal, ...currentAssessmentStructure.pb, ...currentAssessmentStructure.ups ];
                
                assessmentSelectEl.innerHTML = '<option value="">-- Pilih Penilaian --</option>';
                allAssessments.forEach(ass => {
                    const option = document.createElement('option');
                    option.value = ass.name;
                    option.textContent = `${ass.fullName} (Markah Penuh: ${ass.fullMarks})`;
                    assessmentSelectEl.appendChild(option);
                });
                markEntryArea.classList.add('hidden');
            }

            function renderMarkEntryTable() {
                const assessmentName = assessmentSelectEl.value;
                if (!assessmentName || !state.currentClass) {
                    markEntryArea.classList.add('hidden');
                    return;
                }
                const assessment = allAssessments.find(a => a.name === assessmentName);
                if (!assessment) {
                    console.error(`Assessment ${assessmentName} not found in structure.`);
                    markEntryArea.classList.add('hidden');
                    return;
                }

                currentAssessmentDisplay.textContent = assessment.fullName;
                markEntryHead.innerHTML = `<tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Bil.</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Pelajar</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">No. Matrik</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Markah (/ ${assessment.fullMarks})</th></tr>`;
                markEntryBody.innerHTML = '';
                const students = state.classes[state.currentClass]?.students || [];
                const classScores = state.scores[state.currentClass] || {};
                
                students.forEach((student, index) => {
                    const studentScores = classScores[student.NoMatrik] || {};
                    const score = studentScores[assessment.name] === null || studentScores[assessment.name] === undefined ? '' : studentScores[assessment.name];
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${index + 1}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${student.NamaPelajar}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${student.NoMatrik}</td><td class="px-6 py-4"><input type="number" class="score-input w-24 rounded-md border-slate-300" data-student-matric="${student.NoMatrik}" value="${score}"></td>`;
                    markEntryBody.appendChild(row);
                });
                markEntryArea.classList.remove('hidden');
            }
            
            function calculateScores(className, studentMatric, program) {
                const classScores = state.scores[className] || {};
                const studentScores = classScores[studentMatric] || {};
                const structure = assessmentStructures[program] || assessmentStructures.SES; // Guna struktur yg betul
                
                const results = { pb: 0, ups: 0, ut: 0, totalEtr: 0 };
                structure.pb.forEach(ass => { const score = parseFloat(studentScores[ass.name] || 0); if (!isNaN(score)) results.pb += (score / ass.fullMarks) * ass.weightage; });
                
                let totalUpsScore = 0, totalUpsFullMarks = 0;
                structure.ups.forEach(ass => { 
                    const score = parseFloat(studentScores[ass.name]); 
                    if (!isNaN(score)) {
                        totalUpsScore += score;
                        totalUpsFullMarks += ass.fullMarks;
                    }
                });
                if(totalUpsFullMarks > 0) results.ups = (totalUpsScore / totalUpsFullMarks) * totalWeightageUPS;

                let totalTopikalPercentage = 0, topikalCount = 0;
                structure.topikal.forEach(ass => { const score = parseFloat(studentScores[ass.name]); if (!isNaN(score)) { totalTopikalPercentage += (score / ass.fullMarks) * 100; topikalCount++; } });
                if (topikalCount > 0) results.ut = (totalTopikalPercentage / topikalCount) * (totalWeightageTopikal / 100);
                results.totalEtr = results.pb + results.ups + results.ut;
                return results;
            }

            function renderAllClassReports() {
                if (!state.currentClass || !state.classes[state.currentClass]) { pbUpsReportDisplay.innerHTML = '<p class="text-slate-500">Sila pilih kelas untuk memaparkan laporan.</p>'; topikalReportDisplay.innerHTML = '<p class="text-slate-500">Sila pilih kelas untuk memaparkan laporan.</p>'; return; }
                reportClassNameEl.textContent = state.currentClass;
                const currentClassData = state.classes[state.currentClass];
                const students = currentClassData.students;
                const program = currentClassData.program;
                const structure = assessmentStructures[program];
                const classScores = state.scores[state.currentClass] || {};

                let pbUpsHeader = `<thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-2 py-2">Bil</th><th class="px-2 py-2">Nama</th>`;
                structure.pb.forEach(a => pbUpsHeader += `<th class="px-2 py-2">${a.name}</th>`);
                structure.ups.forEach(a => pbUpsHeader += `<th class="px-2 py-2">${a.name}</th>`);
                pbUpsHeader += `<th class="px-2 py-2 font-bold text-blue-600">Jml PB</th><th class="px-2 py-2 font-bold text-blue-600">Jml UPS</th><th class="px-2 py-2 font-bold text-green-600">AKHIR</th></tr></thead>`;
                let pbUpsBody = '<tbody>';
                students.forEach((student, index) => {
                    const studentScores = classScores[student.NoMatrik] || {};
                    const calculated = calculateScores(state.currentClass, student.NoMatrik, program);
                    pbUpsBody += `<tr class="bg-white border-b"><td class="px-2 py-2">${index + 1}</td><td class="px-2 py-2 text-left font-medium text-slate-900">${student.NamaPelajar}</td>`;
                    structure.pb.forEach(a => { const score = studentScores[a.name]; const scoreDisplay = (score === null || score === undefined) ? '' : score; const weightedScore = (score === null || score === undefined) ? '' : `(${(score / a.fullMarks * a.weightage).toFixed(2)}%)`; pbUpsBody += `<td class="px-2 py-2">${scoreDisplay} <span class="text-xs text-slate-500">${weightedScore}</span></td>`; });
                    structure.ups.forEach(a => pbUpsBody += `<td class="px-2 py-2">${studentScores[a.name] === null || studentScores[a.name] === undefined ? '' : studentScores[a.name]}</td>`);
                    pbUpsBody += `<td class="px-2 py-2 font-bold text-blue-600">${calculated.pb.toFixed(2)}</td><td class="px-2 py-2 font-bold text-blue-600">${calculated.ups.toFixed(2)}</td><td class="px-2 py-2 font-bold text-green-600">${(calculated.pb + calculated.ups).toFixed(2)}</td></tr>`;
                });
                pbUpsBody += '</tbody>';
                pbUpsReportDisplay.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500">${pbUpsHeader}${pbUpsBody}</table></div>`;
                
                let topikalHeader = `<thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-2 py-2">Bil</th><th class="px-2 py-2">Nama</th>`;
                structure.topikal.forEach(a => topikalHeader += `<th class="px-2 py-2">${a.name}</th>`);
                topikalHeader += `<th class="px-2 py-2 font-bold text-purple-600">Jml UT (/40)</th><th class="px-2 py-2 font-bold text-red-600">ETR (/100)</th></tr></thead>`;
                let topikalBody = '<tbody>';
                students.forEach((student, index) => {
                    const studentScores = classScores[student.NoMatrik] || {};
                    const calculated = calculateScores(state.currentClass, student.NoMatrik, program);
                    topikalBody += `<tr class="bg-white border-b"><td class="px-2 py-2">${index + 1}</td><td class="px-2 py-2 text-left font-medium text-slate-900">${student.NamaPelajar}</td>`;
                    structure.topikal.forEach(a => topikalBody += `<td class="px-2 py-2">${studentScores[a.name] === null || studentScores[a.name] === undefined ? '' : studentScores[a.name]}</td>`);
                    topikalBody += `<td class="px-2 py-2 font-bold text-purple-600">${calculated.ut.toFixed(2)}</td>`;
                    topikalBody += `<td class="px-2 py-2 font-bold text-red-600">${calculated.totalEtr.toFixed(2)}</td></tr>`;
                });
                topikalBody += '</tbody>';
                topikalReportDisplay.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500">${topikalHeader}${topikalBody}</table></div>`;
            }

            function renderDashboard() {
                const headerStructure = assessmentStructures.SES; // Guna SES sebagai rujukan header penuh
                const allHeaderAssessments = [ ...headerStructure.topikal, ...headerStructure.pb, ...headerStructure.ups ];

                // Hasilkan Header
                let headHTML = `<tr><th rowspan="2" class="px-2 py-2 text-left text-xs font-medium text-slate-500 uppercase sticky left-0 bg-slate-50 z-10">Kelas</th>`;
                headHTML += `<th colspan="${headerStructure.topikal.length}" class="px-2 py-2 text-xs font-medium text-slate-500 uppercase bg-slate-100">Ujian Topikal</th>`;
                headHTML += `<th colspan="${headerStructure.pb.length}" class="px-2 py-2 text-xs font-medium text-slate-500 uppercase bg-slate-200">Penilaian Berterusan (PB)</th>`;
                headHTML += `<th colspan="${headerStructure.ups.length}" class="px-2 py-2 text-xs font-medium text-slate-500 uppercase bg-slate-100">Ujian Penilaian Sumatif (UPS)</th></tr>`;
                headHTML += `<tr>`;
                allHeaderAssessments.forEach(ass => {
                    headHTML += `<th class="px-2 py-2 text-xs font-medium text-slate-500 uppercase" data-assessment-name="${ass.name}">${ass.name}</th>`;
                });
                headHTML += `</tr>`;
                dashboardTableHead.innerHTML = headHTML;

                // Tentukan kelas mana untuk dipaparkan berdasarkan viewMode
                let classesToDisplay = [];
                if (state.viewMode === 'pensyarah') {
                    classesToDisplay = state.lecturerDetails.KelasDiajar;
                } else { // admin atau ketua_unit
                    classesToDisplay = Object.keys(state.classes);
                }
                
                // Hasilkan Body
                let bodyHTML = '';
                classesToDisplay.sort().forEach(className => {
                    bodyHTML += `<tr class="bg-white border-b" data-class-name="${className}"><td class="px-2 py-2 text-left font-medium text-slate-900 sticky left-0 bg-white">${className}</td>`;
                    const classData = state.classes[className];
                    if (!classData) {
                        allHeaderAssessments.forEach(() => {
                             bodyHTML += `<td class="px-2 py-2 text-center text-gray-400 text-xl">N/A</td>`;
                        });
                        bodyHTML += `</tr>`;
                        return;
                    }
                    
                    const students = classData.students || [];
                    const classScores = state.scores[className] || {};
                    const structure = assessmentStructures[classData.program] || assessmentStructures.SES;
                    const classAssessments = [ ...structure.topikal, ...structure.pb, ...structure.ups ];

                    // Padankan dengan header penuh
                    allHeaderAssessments.forEach(headerAss => {
                        const ass = classAssessments.find(a => a.name === headerAss.name);
                        if (!ass) {
                            bodyHTML += `<td class="px-2 py-2 text-center text-gray-400 bg-gray-100">-</td>`; // Tidak berkenaan
                            return;
                        }
                        
                        let isComplete = true;
                        if (students.length === 0) {
                            isComplete = false; 
                        } else {
                            for (const student of students) {
                                const studentScores = classScores[student.NoMatrik] || {};
                                const score = studentScores[ass.name];
                                if (score === null || score === undefined || score === '') {
                                    isComplete = false;
                                    break;
                                }
                            }
                        }
                        
                        if(isComplete) {
                            bodyHTML += `<td class="px-2 py-2 text-center text-green-600 text-xl">✅</td>`;
                        } else {
                            bodyHTML += `<td class="px-2 py-2 text-center text-red-600 text-xl">❌</td>`;
                        }
                    });
                    bodyHTML += `</tr>`;
                });
                dashboardTableBody.innerHTML = bodyHTML;
            }

            function renderAnalysisTable() {
                const analysisClasses = Object.keys(state.classes); // Analisis sentiasa untuk semua kelas
                
                let headHTML = `<tr>
                    <th class="px-2 py-2 text-left text-xs font-medium text-slate-500 uppercase">Kelas</th>
                    <th class="px-2 py-2 text-xs font-medium text-slate-500 uppercase">Program</th>
                    <th class="px-2 py-2 text-xs font-medium text-slate-500 uppercase">Bil. Pelajar</th>
                    <th class="px-2 py-2 font-bold text-blue-600 uppercase">Purata PB (/40)</th>
                    <th class="px-2 py-2 font-bold text-blue-600 uppercase">Purata UPS (/20)</th>
                    <th class="px-2 py-2 font-bold text-green-600 uppercase">Purata Akhir (/60)</th>
                    <th class="px-2 py-2 font-bold text-purple-600 uppercase">Purata ETR (/100)</th>
                </tr>`;
                analysisTableHead.innerHTML = headHTML;
                
                let bodyHTML = '';
                analysisClasses.sort().forEach(className => {
                    const classData = state.classes[className];
                    if (!classData) return;

                    const students = classData.students || [];
                    const program = classData.program;
                    
                    let totalPb = 0, totalUps = 0, totalAkhir = 0, totalEtr = 0;
                    
                    students.forEach(student => {
                        const calculated = calculateScores(className, student.NoMatrik, program);
                        totalPb += calculated.pb;
                        totalUps += calculated.ups;
                        totalAkhir += (calculated.pb + calculated.ups);
                        totalEtr += calculated.totalEtr;
                    });
                    
                    const studentCount = students.length || 1; // Elak pembahagian dengan 0
                    bodyHTML += `<tr class="bg-white border-b">
                        <td class="px-2 py-2 text-left font-medium text-slate-900">${className}</td>
                        <td class="px-2 py-2 text-center text-slate-500">${program}</td>
                        <td class="px-2 py-2 text-center text-slate-500">${students.length}</td>
                        <td class="px-2 py-2 font-bold text-blue-600 text-center">${(totalPb / studentCount).toFixed(2)}</td>
                        <td class="px-2 py-2 font-bold text-blue-600 text-center">${(totalUps / studentCount).toFixed(2)}</td>
                        <td class="px-2 py-2 font-bold text-green-600 text-center">${(totalAkhir / studentCount).toFixed(2)}</td>
                        <td class="px-2 py-2 font-bold text-purple-600 text-center">${(totalEtr / studentCount).toFixed(2)}</td>
                    </tr>`;
                });
                analysisTableBody.innerHTML = bodyHTML;
            }

            function renderAdminTab() {
                // Isi dropdown program
                adminProgramSelect.innerHTML = '<option value="">Pilih Program</option>';
                Object.keys(assessmentStructures).forEach(programName => {
                    adminProgramSelect.add(new Option(programName, programName));
                });
                
                // Isi dropdown kelas
                adminClassSelect.innerHTML = '<option value="">Pilih Program Dahulu</option>';
                adminProgramSelect.addEventListener('change', () => {
                    const selectedProgram = adminProgramSelect.value;
                    adminClassSelect.innerHTML = '<option value="">Pilih Kelas</option>';
                    const classesInProgram = [...new Set(state.allLecturers
                        .filter(l => l.Program === selectedProgram)
                        .map(l => l.KelasDiajar.trim())
                    )];
                    classesInProgram.sort().forEach(className => {
                        adminClassSelect.add(new Option(className, className));
                    });
                });

                adminClassSelect.addEventListener('change', () => {
                    adminMarkEntry.classList.remove('hidden');
                    const program = adminProgramSelect.value;
                    const structure = assessmentStructures[program];
                    const allAdminAssessments = [...structure.topikal, ...structure.pb, ...structure.ups];
                    
                    adminAssessmentSelect.innerHTML = '<option value="">-- Pilih Penilaian --</option>';
                    allAdminAssessments.forEach(ass => {
                        adminAssessmentSelect.add(new Option(`${ass.fullName} (${ass.fullMarks})`, ass.name));
                    });
                });
                
                adminAssessmentSelect.addEventListener('change', renderAdminMarkEntryTable);
                adminSaveMarksBtn.addEventListener('click', () => saveScoresToSupabase(true));
            }

            function renderAdminMarkEntryTable() {
                const assessmentName = adminAssessmentSelect.value;
                const className = adminClassSelect.value;
                const program = adminProgramSelect.value;
                
                if (!assessmentName || !className || !program) {
                    adminMarkEntryArea.classList.add('hidden');
                    return;
                }
                
                const structure = assessmentStructures[program];
                const allAdminAssessments = [...structure.topikal, ...structure.pb, ...structure.ups];
                const assessment = allAdminAssessments.find(a => a.name === assessmentName);

                adminCurrentAssessmentDisplay.textContent = `${className} - ${assessment.fullName}`;
                adminMarkEntryHead.innerHTML = `<tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Bil.</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Pelajar</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">No. Matrik</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Markah (/ ${assessment.fullMarks})</th></tr>`;
                adminMarkEntryBody.innerHTML = '';
                
                const students = state.allStudents.filter(s => s.Kelas === className && s.Program === program) || [];
                const classScores = state.scores[className] || {};
                
                students.forEach((student, index) => {
                    const studentScores = classScores[student.NoMatrik] || {};
                    const score = studentScores[assessment.name] === null || studentScores[assessment.name] === undefined ? '' : studentScores[assessment.name];
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${index + 1}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${student.NamaPelajar}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${student.NoMatrik}</td><td class="px-6 py-4"><input type="number" class="score-input w-24 rounded-md border-slate-300" data-student-matric="${student.NoMatrik}" value="${score}"></td>`;
                    adminMarkEntryBody.appendChild(row);
                });
                adminMarkEntryArea.classList.remove('hidden');
            }
            
            // Listener untuk admin mark entry
            adminMarkEntryBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('score-input')) {
                    const studentMatric = e.target.dataset.studentMatric;
                    const assessmentName = adminAssessmentSelect.value;
                    const className = adminClassSelect.value;
                    const score = e.target.value;

                    if (!state.scores[className]) state.scores[className] = {};
                    if (!state.scores[className][studentMatric]) state.scores[className][studentMatric] = {};
                    state.scores[className][studentMatric][assessmentName] = score === '' ? null : parseFloat(score);
                }
            });

            // --- Event Listeners ---
            
            assessmentSelectEl.addEventListener('change', renderMarkEntryTable);

            markEntryBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('score-input')) {
                    const studentMatric = e.target.dataset.studentMatric;
                    const assessmentName = assessmentSelectEl.value;
                    const score = e.target.value;
                    if (!state.scores[state.currentClass]) state.scores[state.currentClass] = {};
                    if (!state.scores[state.currentClass][studentMatric]) state.scores[state.currentClass][studentMatric] = {};
                    state.scores[state.currentClass][studentMatric][assessmentName] = score === '' ? null : parseFloat(score);
                }
            });
            
            markEntryBody.addEventListener('paste', (e) => {
                if (!e.target.classList.contains('score-input')) return;
                e.preventDefault();
                const text = e.clipboardData.getData('text/plain');
                const marks = text.split(/\r?\n/).filter(m => m.trim() !== '');
                const allInputs = Array.from(markEntryBody.querySelectorAll('.score-input'));
                let startIndex = allInputs.indexOf(e.target);
                const assessmentName = assessmentSelectEl.value;
                
                if (!state.scores[state.currentClass]) state.scores[state.currentClass] = {};

                marks.forEach((mark, i) => {
                    let currentIndex = startIndex + i;
                    if (currentIndex < allInputs.length) {
                        const currentInput = allInputs[currentIndex];
                        const studentMatric = currentInput.dataset.studentMatric;
                        currentInput.value = mark.trim();
                        if (!state.scores[state.currentClass][studentMatric]) state.scores[state.currentClass][studentMatric] = {};
                        state.scores[state.currentClass][studentMatric][assessmentName] = mark.trim() === '' ? null : parseFloat(mark.trim());
                    }
                });
            });

            saveMarksBtn.addEventListener('click', () => saveScoresToSupabase(false));

            // Pengurusan Tab Utama
            function switchTab(activeTab) {
                const tabs = { dashboard: tabDashboard, entry: tabEntry, report: tabReport, analysis: tabAnalysis, admin: tabAdmin };
                const contents = { dashboard: dashboardContent, entry: entryContent, report: reportContentArea, analysis: analysisContent, admin: adminContent };

                for (const key in tabs) {
                    if (key === activeTab) {
                        tabs[key].className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600 flex items-center';
                        if(contents[key]) contents[key].classList.remove('hidden');
                    } else {
                        tabs[key].className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent flex items-center';
                        if(contents[key]) contents[key].classList.add('hidden');
                    }
                }
                
                // Pastikan tab yang tiada akses kekal tersembunyi
                if (state.user.role !== 'admin') tabAdmin.classList.add('hidden');
                if (state.user.role === 'pensyarah') tabAnalysis.classList.add('hidden');
            }

            tabDashboard.addEventListener('click', () => {
                switchTab('dashboard');
                renderDashboard();
            });

            tabEntry.addEventListener('click', () => {
                if (!state.currentClass) {
                    alert("Sila pilih kelas dari dashboard dahulu.");
                    return;
                }
                switchTab('entry');
            });

            tabReport.addEventListener('click', () => {
                if (!state.currentClass) {
                    alert("Sila pilih kelas dari dashboard dahulu.");
                    return;
                }
                switchTab('report');
                renderAllClassReports();
                updatePrintableArea();
            });
            
            tabAnalysis.addEventListener('click', () => {
                switchTab('analysis');
                renderAnalysisTable();
            });

            tabAdmin.addEventListener('click', () => {
                switchTab('admin');
            });
            
            // Listener untuk Dashboard Interaktif
            dashboardTableBody.addEventListener('click', (e) => {
                const cell = e.target.closest('td');
                if (!cell) return; 

                const row = cell.closest('tr');
                const className = row.dataset.className;
                if (!className) return;

                // 1. Tetapkan kelas aktif
                state.currentClass = className;
                state.currentProgram = state.classes[className]?.program; // Dapatkan program untuk kelas ini
                localStorage.setItem('currentClass_supabase_v1', state.currentClass);
                
                // 2. Kemaskini paparan "Kelas Aktif"
                updateActiveClassDisplay(); 
                
                // 3. Paparkan kandungan utama
                mainContentEl.classList.remove('hidden');

                if (cell.cellIndex === 0) { 
                    // Pengguna mengklik nama kelas.
                    // Bawa pengguna ke tab Laporan secara lalai
                    switchTab('report');
                    renderAllClassReports();
                    updatePrintableArea();
                } else {
                    // Pengguna mengklik ikon (jalan pintas)
                    const assessmentName = allAssessments[cell.cellIndex - 1].name;
                    if (!assessmentName) return;

                    // 1. Tukar ke tab Kemasukan Markah
                    switchTab('entry');
                    
                    // 2. Tetapkan penilaian
                    renderAssessmentSelector(); // Panggil ini untuk pastikan struktur penilaian yang betul dimuatkan
                    assessmentSelectEl.value = assessmentName;
                    
                    // 3. Paparkan jadual (data sudah ada dalam state.scores)
                    renderMarkEntryTable(); 
                }
            });


            // Pengurusan Sub-Tab Laporan
            tabReportPbUps.addEventListener('click', () => {
                pbUpsReportDisplay.classList.remove('hidden'); topikalReportDisplay.classList.add('hidden');
                tabReportPbUps.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600';
                tabReportTopikal.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent';
                updatePrintableArea();
            });

            tabReportTopikal.addEventListener('click', () => {
                topikalReportDisplay.classList.remove('hidden'); pbUpsReportDisplay.classList.add('hidden');
                tabReportTopikal.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600';
                tabReportPbUps.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent';
                updatePrintableArea();
            });
            
            function prepareAndPrint() {
                if (!state.currentClass) {
                    alert("Sila pilih kelas dari dashboard terlebih dahulu.");
                    return;
                }
                const lecturerName = state.user.full_name || 'Tidak Ditetapkan';
                const className = state.currentClass;
                const reportTitle = !pbUpsReportDisplay.classList.contains('hidden') ? 'Laporan Penilaian Berterusan & UPS' : 'Laporan Ujian Topikal (ETR)';
                const activeReportContent = !pbUpsReportDisplay.classList.contains('hidden') ? pbUpsReportDisplay.innerHTML : topikalReportDisplay.innerHTML;

                const printHTML = `
                    <div class="space-y-4">
                        <div class="text-center">
                            <h2 class="text-xl font-bold">LAPORAN PEMARKAHAN PELAJAR</h2>
                            <h3 class="text-lg font-semibold">${reportTitle}</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <p><strong>Nama Pensyarah:</strong> ${lecturerName}</p>
                            <p><strong>Nama Kelas:</strong> ${className}</p>
                        </div>
                        <div>
                           ${activeReportContent}
                        </div>
                        <div class="pt-16 text-sm">
                            <p>...........................................................</p>
                            <p><strong>Tandatangan Pensyarah,</strong></p>
                            <br>
                            <p><strong>Tarikh:</strong> ${new Date().toLocaleDateString('ms-MY')}</p>
                        </div>
                    </div>
                `;
                printContainer.innerHTML = printHTML;
                window.print();
            }

            printClassReportBtn.addEventListener('click', prepareAndPrint);
            
            viewModeSelectEl.addEventListener('change', () => {
                state.viewMode = viewModeSelectEl.value;
                localStorage.setItem('viewMode_v13', state.viewMode);
                renderDashboard();
            });

            async function startApp() {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if(session) {
                    await initializeAndFetchData(session.user);
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                } else {
                    loginScreen.classList.remove('hidden');
                    appScreen.classList.add('hidden');
                }
            }

            loginBtn.addEventListener('click', async () => {
                const email = emailEl.value;
                const password = passwordEl.value;
                loginErrorEl.classList.add('hidden');

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if(error) {
                    loginErrorEl.textContent = error.message;
                    loginErrorEl.classList.remove('hidden');
                } else if (data.user) {
                    await initializeAndFetchData(data.user);
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                }
            });

            logoutBtn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                state.currentClass = null;
                localStorage.removeItem('currentClass_supabase_v1');
                localStorage.removeItem('viewMode_v13');
            });

            function updatePrintableArea() {
                if (!pbUpsReportDisplay.classList.contains('hidden')) { 
                    pbUpsReportDisplay.classList.add('printable-area'); 
                    topikalReportDisplay.classList.remove('printable-area'); 
                } 
                else { 
                    topikalReportDisplay.classList.add('printable-area'); 
                    pbUpsReportDisplay.classList.remove('printable-area'); 
                }
            }

            startApp();

        });
    </script>
</body>
</html>
